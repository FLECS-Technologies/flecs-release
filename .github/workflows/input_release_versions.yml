name: Inputs for new release versions
on:
  workflow_dispatch:
    inputs:
      core_version:
        description: New core version
        required: false
        type: string
      webapp_version:
        description: New webapp version
        required: false
        type: string
      console_version:
        description: New console version
        required: false
        type: string
      core_branch:
        description: Branch for new core version
        required: false
        type: string
        default: main
      webapp_branch:
        description: Branch for new webapp version
        required: false
        type: string
        default: main
      console_branch:
        description: Branch for new console version
        required: false
        type: string
        default: main
      test_should_fail:
        description: simulate failure of workflow
        required: false
        type: string
      test_should_timeout:
        description: simulation timeout of workflow
        required: false
        type: string
env:
  INPUT_CORE_VERSION: ${{ inputs.core_version }}
  INPUT_CORE_BRANCH: ${{ inputs.core_branch }}
  INPUT_WEBAPP_VERSION: ${{ inputs.webapp_version }}
  INPUT_WEBAPP_BRANCH: ${{ inputs.webapp_branch }}
  INPUT_CONSOLE_VERSION: ${{ inputs.console_version }}
  INPUT_CONSOLE_BRANCH: ${{ inputs.console_branch }}
  V3_PATTERN: '^v3\.[0-9]+\.[0-9]+-hedgehog$'
  V4_PATTERN: '^v4\.[0-9]+\.[0-9]+-snowhare$'
  CONSOLE_PATTERN: '^v3\.[0-9]+\.[0-9]+'
jobs:
    validate_inputs:
      runs-on: ubuntu-latest
      steps:
        - name: check core version with Regex
          run: |
            if [[ -n "${{ inputs.core_version }}" && ! ("${{ inputs.core_version }}" =~ $V3_PATTERN || "${{ inputs.core_version }}" =~ $V4_PATTERN) ]]; then
              echo "Error: Core version does not match a valid pattern" >&2
              exit 1
            fi
        - name: check webapp version with Regex
          run: |
            if [[ -n "${{ inputs.webapp_version }}" && ! ("${{ inputs.webapp_version }}" =~ $V3_PATTERN || "${{ inputs.webapp_version }}" =~ $V4_PATTERN) ]]; then
              echo "Error: Webapp version does not match a valid pattern" >&2
              exit 1
            fi
        - name: check console version with Regex
          run: |
            if [[ -n "${{ inputs.console_version }}" && ! ("${{ inputs.console_version }}" =~ $CONSOLE_PATTERN) ]]; then
              echo "Error: Console version does not match a valid pattern" >&2
              exit 1
            fi
    generate_token:
      runs-on: ubuntu-latest
      outputs:
        app_token: ${{ steps.app-token.outputs.token }}
      steps:
        - name: Generate GitHub App Token
          id: app-token
          uses: actions/create-github-app-token@v1
          with:
            app-id: ${{ secrets.FLECS_WORKFLOW_AUTOMATION_CLIENT_ID }}
            private-key: ${{ secrets.FLECS_WORKFLOW_AUTOMATION_KEY  }}
            owner: FLECS-Technologies
            repositories: |
              flecs-webapp-dummy
    release_webapp:
      uses: FLECS-Technologies/flecs-webapp-dummy/.github/workflows/release_webapp.yml@main
      needs: [validate_inputs, generate_token]
      with:
        env_webapp_version: ${{ inputs.webapp_version }}
        env_webapp_branch: ${{ inputs.webapp_branch }}
        should_fail: ${{ inputs.test_should_fail }}
        should_timeout: ${{ inputs.test_should_timeout }}
      secrets:
        app_id: ${{ secrets.FLECS_WORKFLOW_AUTOMATION_CLIENT_ID }}
        private_key: ${{ secrets.FLECS_WORKFLOW_AUTOMATION_KEY  }}